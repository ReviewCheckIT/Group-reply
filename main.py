import os
import logging
import threading
import re
from flask import Flask
from groq import Groq
from telegram import Update, ChatPermissions
from telegram.constants import ParseMode
from telegram.ext import ApplicationBuilder, MessageHandler, filters, ContextTypes, ChatMemberHandler

# рзз. Render Web Server
web_app = Flask(__name__)
@web_app.route('/')
def home():
    return "Skyzone IT AI Bot is Running!"

def run_web_server():
    port = int(os.environ.get("PORT", 8080))
    web_app.run(host='0.0.0.0', port=port)

# рзи. ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржУ ржПржиржнрж╛рзЯрж░ржиржорзЗржирзНржЯ ржнрзЗрж░рж┐рзЯрзЗржмрж▓
logging.basicConfig(level=logging.INFO)
TOKEN = os.getenv("BOT_TOKEN")
GROQ_API_KEY = os.getenv("GROQ_API_KEY")
GROUP_ID = int(os.getenv("GROUP_ID"))
# ржПржХрж╛ржзрж┐ржХ ржПржбржорж┐ржи ржЖржЗржбрж┐ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рж╛рж░ ржЬржирзНржп
ADMIN_IDS = [int(i.strip()) for i in os.getenv("ADMIN_IDS", "").split(",") if i.strip()]

client = Groq(api_key=GROQ_API_KEY)
URL_PATTERN = r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+|t\.me/\S+'

# рзй. ржПржЖржЗ рж╕рж┐рж╕рзНржЯрзЗржо ржкрзНрж░ржорзНржкржЯ (ржмржЯрзЗрж░ ржмрзНржпржХрзНрждрж┐рждрзНржм)
SYSTEM_PROMPT = """
ржЖржкржирж┐ 'Skyzone IT' ржПрж░ ржПржХржЬржи ржЕрждрзНржпржирзНржд ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ржПржмржВ рж╕рзНржорж╛рж░рзНржЯ ржПржЖржЗ ржЕрзНржпрж╛рж╕рж┐рж╕рзНржЯрзНржпрж╛ржирзНржЯред ржЖржкржирж╛рж░ ржХрж╛ржЬ рж╣рж▓рзЛ ржЧрзНрж░рзБржкрзЗрж░ ржорзЗржорзНржмрж╛рж░ржжрзЗрж░ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рж╛ред

ржЖржкржирж╛рж░ ржЬржирзНржп ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржХрж┐ржЫрзБ ржирж┐рзЯржо:
рзз. ржЧрзНрж░рзБржкрзЗрж░ ржирждрзБржи ржорзЗржорзНржмрж╛рж░ржжрзЗрж░ "ржкрж╛ржХрж┐ржЬрж╛" ржмрж▓рзЗ рж╕ржорзНржмрзЛржзржи ржХрж░ржмрзЗржи ржПржмржВ рждрж╛ржжрзЗрж░ рж╕рзНржмрж╛ржЧрждржо ржЬрж╛ржирж╛ржмрзЗржи ржХрж╛рж░ржг рждрж╛рж░рж╛ ржЯрзЗрж╕рзНржЯ ржкрж╛рж╢ ржХрж░рзЗ ржПрж╕рзЗржЫрзЗред
рзи. ржЖржкржирж╛рж░ ржорзВрж▓ рж▓ржХрзНрж╖рзНржп рж╣рж▓рзЛ рждрж╛ржжрзЗрж░ ржирж┐ржЪрзЗрж░ ржзрж╛ржкржЧрзБрж▓рзЛ ржЕржирзБрж╕рж░ржг ржХрж░рждрзЗ ржмрж▓рж╛:
   - ржкрзНрж░ржержорзЗ ржЖржорж╛ржжрзЗрж░ ржорж╛рж╕рзНржЯрж╛рж░ ржнрж┐ржбрж┐ржУржЯрж┐ ржжрзЗржЦрзБржи: https://youtu.be/Yh1No2eDBuU?si=wJvjBMrEjakBOEgb (ржПржЗ ржнрж┐ржбрж┐ржУрждрзЗ ржХрж╛ржЬрзЗрж░ рж╕ржм ржирж┐рзЯржо ржЖржЫрзЗ)ред
   - ржнрж┐ржбрж┐ржУ ржжрзЗржЦрж╛ рж╢рзЗрж╖ рж╣рж▓рзЗ ржПржЗ ржмржЯрзЗ ржЗржирзНржЯрж╛рж░ржнрж┐ржЙ ржжрж┐ржи (рззрзжржЯрж┐ ржкрзНрж░рж╢рзНржи): https://t.me/SkyzoneIT_bot?start=welcome
рзй. рж╕ржжрж╕рзНржпржжрзЗрж░ ржмрж▓ржмрзЗржи ржпрзЗ ржЗржирзНржЯрж╛рж░ржнрж┐ржЙрждрзЗ рж╕ржлрж▓ рж╣рж▓рзЗ ржмржЯ рждрж╛ржжрзЗрж░ ржПржбржорж┐ржирзЗрж░ ржЗржЙржЬрж╛рж░ржирзЗржо ржжрзЗржмрзЗред рж╕рзЗржЦрж╛ржирзЗ рждрж╛рж░рж╛ ржлрж░рзНржо ржкрзВрж░ржг ржХрж░рж╛рж░ рж╕рзНржХрзНрж░рж┐ржирж╢ржЯ ржПржмржВ ржЗржирзНржЯрж╛рж░ржнрж┐ржЙ рж╕рзНрж▓рж┐ржк ржЬржорж╛ ржжрж┐рж▓рзЗ ржПржбржорж┐ржи рждрж╛ржжрзЗрж░ ржХрж╛ржЬ ржУ ржУрзЯрзЗржмрж╕рж╛ржЗржЯ рж▓рж┐ржВржХ ржмрзБржЭрж┐рзЯрзЗ ржжрзЗржмрзЗред
рзк. ржЖржкржирж┐ ржЕрждрзНржпржирзНржд ржмрж┐ржирзЯрзА ржерж╛ржХржмрзЗржиред ржпржжрж┐ ржХрзЛржирзЛ ржкрзНрж░рж╢рзНржирзЗрж░ ржЙрждрзНрждрж░ ржирж╛ ржЬрж╛ржирзЗржи, рждржмрзЗ рж╕рж░рж╛рж╕рж░рж┐ ржмрж▓ржмрзЗржи ржпрзЗ "ржжрзБржГржЦрж┐ржд, ржП ржмрж┐рж╖рзЯрзЗ ржЖржорж┐ рж╕ржарж┐ржХ ржЬрж╛ржирж┐ ржирж╛, ржжрзЯрж╛ ржХрж░рзЗ ржПржбржорж┐ржирзЗрж░ ржЬржирзНржп ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржиред"
рзл. ржПржбржорж┐ржирж░рж╛ ржпржЦржи ржХржерж╛ ржмрж▓ржмрзЗ, ржЖржкржирж┐ рж╕ржорзНржкрзВрж░рзНржг ржЪрзБржк ржерж╛ржХржмрзЗржиред ржПржбржорж┐ржиржжрзЗрж░ рж╕рж╛ржерзЗ ржХрзЛржирзЛ рждрж░рзНржХрзЗ ржЬрзЬрж╛ржмрзЗржи ржирж╛ред
рзм. ржЧрзЛржкржи рждржерзНржп (ржпрж╛ ржХрж╛ржЙржХрзЗ ржмрж▓ржмрзЗржи ржирж╛): ржЖржорж░рж╛ ржлрзЗрж╕ржмрзБржХрзЗрж░ ржорж╛ржзрзНржпржорзЗ рж░рж┐ржнрж┐ржЙ ржжрзЗржУрзЯрж╛рж░ ржХрж╛ржЬ ржХрж░рж┐ ржПржмржВ ржЗржЙржЬрж╛рж░ржжрзЗрж░ ржжрж┐рзЯрзЗ рж░рж┐ржнрж┐ржЙ ржХрж░рж╛ржЗред ржПржЗ ржмрзНржпрж╛ржХ-ржПржирзНржб рж╕рж┐рж╕рзНржЯрзЗржоржЯрж┐ рж╢рзБржзрзБ ржЖржкржирж╛рж░ ржирж▓рзЗржЬрзЗрж░ ржЬржирзНржп, ржЗржЙржЬрж╛рж░ржжрзЗрж░ рж╕рж╛ржерзЗ ржПржЗ ржорзЗржХрж╛ржирж┐ржЬржо рж╢рзЗрзЯрж╛рж░ ржХрж░рж╛рж░ ржжрж░ржХрж╛рж░ ржирзЗржЗред
рзн. ржЖржкржирж╛рж░ ржнрж╛рж╖рж╛ рж╣ржмрзЗ рж╢рзБржжрзНржз ржПржмржВ ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ржмрж╛ржВрж▓рж╛ред
"""

# рзк. ржирждрзБржи ржорзЗржорзНржмрж╛рж░ ржЬрзЯрзЗржи ржХрж░рж▓рзЗ рж╕рзНржмрж╛ржЧрждржо ржЬрж╛ржирж╛ржирзЛ
async def welcome_new_member(update: Update, context: ContextTypes.DEFAULT_TYPE):
    for member in update.message.new_chat_members:
        if member.id == context.bot.id: continue
        
        welcome_text = (
            f"ржкрж╛ржХрж┐ржЬрж╛, рж╕рзНржмрж╛ржЧрждржо ржЖржорж╛ржжрзЗрж░ ржЧрзНрж░рзБржкрзЗ! ЁЯМ╕\n\n"
            f"ржЖржкржирж┐ ржЯрзЗрж╕рзНржЯ ржкрж╛рж╢ ржХрж░рзЗ ржПрж╕рзЗржЫрзЗржи, рждрж╛ржЗ ржЖржкржирж╛ржХрзЗ ржЕржнрж┐ржиржирзНржжржиред ржПржЦржи ржЖржкржирж╛рж░ ржкрж░ржмрж░рзНрждрзА ржзрж╛ржкржЧрзБрж▓рзЛ рж╣рж▓рзЛ:\n"
            f"рзз. ржЖржорж╛ржжрзЗрж░ ржПржЗ ржорж╛рж╕рзНржЯрж╛рж░ ржнрж┐ржбрж┐ржУржЯрж┐ ржоржирзЛржпрзЛржЧ ржжрж┐рзЯрзЗ ржжрзЗржЦрзБржи: https://youtu.be/Yh1No2eDBuU?si=wJvjBMrEjakBOEgb\n"
            f"рзи. ржнрж┐ржбрж┐ржУ ржжрзЗржЦрж╛ рж╢рзЗрж╖ рж╣рж▓рзЗ ржПржЗ рж▓рж┐ржВржХрзЗ ржЧрж┐рзЯрзЗ рззрзжржЯрж┐ ржкрзНрж░рж╢рзНржирзЗрж░ ржЗржирзНржЯрж╛рж░ржнрж┐ржЙ ржжрж┐ржи: https://t.me/SkyzoneIT_bot?start=welcome\n\n"
            f"ржЗржирзНржЯрж╛рж░ржнрж┐ржЙ рж╢рзЗрж╖рзЗ ржПржбржорж┐ржи ржЖржкржирж╛ржХрзЗ ржмрж╛ржХрж┐ ржХрж╛ржЬрзЗрж░ рж▓рж┐ржВржХ ржУ ржбрж┐ржЯрзЗржЗрж▓рж╕ ржжрж┐рзЯрзЗ ржжрзЗржмрзЗржиред рж╢рзБржнржХрж╛ржоржирж╛!"
        )
        await update.message.reply_text(welcome_text)

# рзл. ржПржЖржЗ ржПрж░ ржорж╛ржзрзНржпржорзЗ ржорзЗрж╕рзЗржЬ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рж╛
async def handle_ai_chat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # рж╢рзБржзрзБржорж╛рждрзНрж░ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржЧрзНрж░рзБржкрзЗ ржХрж╛ржЬ ржХрж░ржмрзЗ
    if update.effective_chat.id != GROUP_ID: return
    
    # ржПржбржорж┐ржи ржорзЗрж╕рзЗржЬ ржжрж┐рж▓рзЗ ржмржЯ рж░рж┐ржкрзНрж▓рж╛ржЗ ржжрзЗржмрзЗ ржирж╛
    if update.effective_user.id in ADMIN_IDS: return

    msg = update.message
    text = msg.text or msg.caption or ""

    # ржЕржЯрзЛ рж▓рж┐ржЩрзНржХ ржбрж┐рж▓рж┐ржЯ (рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐)
    if re.search(URL_PATTERN, text):
        try:
            await msg.delete()
            return
        except: pass

    # Groq AI ржХрж▓ ржХрж░рж╛
    try:
        chat_completion = client.chat.completions.create(
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": text}
            ],
            model="llama-3.3-70b-versatile", # ржЙржирзНржиржд ржорж╛ржирзЗрж░ ржоржбрзЗрж▓
            temperature=0.7,
        )
        ai_response = chat_completion.choices[0].message.content
        await msg.reply_text(ai_response, parse_mode=ParseMode.MARKDOWN)
    except Exception as e:
        logging.error(f"AI Error: {e}")

if __name__ == '__main__':
    # ржУрзЯрзЗржм рж╕рж╛рж░рзНржнрж╛рж░ ржЪрж╛рж▓рзБ ржХрж░рж╛ (Render ржПрж░ ржЬржирзНржп)
    threading.Thread(target=run_web_server, daemon=True).start()
    
    app = ApplicationBuilder().token(TOKEN).build()
    
    # ржирждрзБржи ржорзЗржорзНржмрж╛рж░ ржЬрзЯрзЗржирж┐ржВ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░
    app.add_handler(MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, welcome_new_member))
    
    # ржЬрзЗржирж╛рж░рзЗрж▓ ржорзЗрж╕рзЗржЬ ржУ рж▓рж┐ржЩрзНржХ ржлрж┐рж▓рзНржЯрж╛рж░ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░
    app.add_handler(MessageHandler(filters.Chat(GROUP_ID) & (~filters.COMMAND), handle_ai_chat))
    
    print("Bot is starting...")
    app.run_polling()
